name: "Main"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  build:

    runs-on: "ubuntu-latest"
    strategy:
      matrix:
        python-version: ["3.11"] # "3.7", "3.8", "3.9", "3.10", 

    steps:
      - uses: "actions/checkout@v4"

      - name: "Set up Python ${{ matrix.python-version }}"
        uses: "actions/setup-python@v4"
        with:
          python-version: "${{ matrix.python-version }}"

      - name: "Install dependencies"
        run: "python -m pip install -r requirements.txt"

      - name: "Build and export 3D models"
        run: "python main.py"

      - name: "Archive builds"
        uses: "actions/upload-artifact@v3"
        with:
          name: builds
          path: build/*

      - name: "Prepare a basic static site that displays the final model"
        run: |
          mkdir -p public
          cp build/assembly.gltf public/
          cat >public/index.html <<EOF
          <!DOCTYPE html>
          <html>
            <head>
              <title>3D Model</title><!--  -->
              <script type="module" src="https://unpkg.com/@google/model-viewer@3.2.1/dist/model-viewer.min.js
              "></script>
              <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
              <style>
                model-viewer { width: 100vw; height: 100vh; }
                body { margin: 0; overflow: hidden; }
              </style>
            </head>
            <body>
              <model-viewer 
                src="assembly.gltf" ar ar-modes="webxr scene-viewer quick-look" camera-controls shadow-intensity="1" auto-rotate
                environment-image="https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/rural_asphalt_road_1k.hdr" 
                skybox-image="https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/rural_asphalt_road_1k.hdr"> </model-viewer>
            </body>
          </html>
          EOF
          # Generate a screenshot of the static site to display on the README.
          sudo apt-get install chromium-browser
          chromium-browser --headless --disable-gpu --screenshot=public/index.png --timeout=30000 public/index.html
      - name: Deploy static site
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: public




